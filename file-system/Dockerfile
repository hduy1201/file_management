# 1ï¸âƒ£ Stage 1: Base image
FROM node:18-alpine AS base

# 2ï¸âƒ£ Äáº·t thÆ° má»¥c lÃ m viá»‡c
WORKDIR /app

# 3ï¸âƒ£ Copy package.json vÃ  package-lock.json Ä‘á»ƒ cÃ i dependencies trÆ°á»›c
COPY package.json package-lock.json ./

# 4ï¸âƒ£ CÃ i Ä‘áº·t dependencies
RUN npm install --frozen-lockfile

# 5ï¸âƒ£ Copy toÃ n bá»™ mÃ£ nguá»“n vÃ o container
COPY . .

# 6ï¸âƒ£ BiÃªn dá»‹ch á»©ng dá»¥ng
RUN npm run build

# 7ï¸âƒ£ Stage 2: Production Image
FROM node:18-alpine AS production

WORKDIR /app

# 8ï¸âƒ£ Copy cÃ¡c file cáº§n thiáº¿t tá»« stage trÆ°á»›c
COPY --from=base /app/node_modules ./node_modules
COPY --from=base /app/dist ./dist
COPY --from=base /app/package.json ./
COPY --from=base /app/prisma ./prisma
COPY --from=base /app/.env ./

# 9ï¸âƒ£ CÃ i Ä‘áº·t production dependencies & táº¡o Prisma Client
RUN npm install --production --frozen-lockfile


# ğŸ”Ÿ Cháº¡y Prisma Generate trÆ°á»›c khi á»©ng dá»¥ng start
RUN npx prisma generate

# ğŸ”¥ Expose port cá»§a á»©ng dá»¥ng
EXPOSE 3000

# ğŸš€ Cháº¡y Prisma Migrate + Start App
CMD npx prisma migrate deploy && node dist/main
